<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Our Anniversary Story</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js"></script>
    <script src="https://unpkg.com/scrollama"></script>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400&display=swap" rel="stylesheet">

    <style>
        /* --- 1. PREMIUM STYLING --- */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Lato', sans-serif;
            color: #333;
            overflow-x: hidden; /* Stop horizontal scroll */
        }
        
        /* The Map Container */
        #map {
            top: 0;
            height: 100vh;
            width: 100vw;
            position: fixed;
            z-index: -1;
        }

        /* Typography */
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            color: #2c3e50;
        }

        /* Header (Title Card) */
        #header {
            margin: auto;
            width: 100%;
            position: relative;
            z-index: 5;
            background: rgba(255, 255, 255, 0.9); /* White fade */
            padding: 4vh 0;
            text-align: center;
            border-bottom: 2px solid #d4af37; /* Gold line */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #header h1 {
            font-size: 3.5em;
            font-style: italic;
            color: #d4af37;
            margin: 0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        #header p {
            font-size: 1.2em;
            color: #555;
            margin-top: 10px;
        }

        /* Story Features Container */
        #features {
            padding-top: 10vh;
            padding-bottom: 10vh;
        }

        /* Individual Story Cards (Glassmorphism) */
        .step {
            padding-bottom: 50vh;
            opacity: 0.25; /* Dim inactive cards */
            transition: opacity 0.6s ease;
        }
        .step.active {
            opacity: 1; /* Highlight active card */
        }
        .step div {
            padding: 30px;
            line-height: 25px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.90); /* Frosted Glass */
            border: 1px solid rgba(212, 175, 55, 0.4); /* Gold Border */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); /* Soft Shadow */
            backdrop-filter: blur(8px);
            border-radius: 12px;
            width: 40%;
            margin-left: 5%; /* Left align */
        }

        /* Image Styling */
        .step img {
            width: 100%;
            border-radius: 8px;
            border: 2px solid #d4af37; /* Gold Frame */
            margin-bottom: 15px;
        }

        /* Music Button */
        #music-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: white;
            padding: 12px;
            border-radius: 50%;
            border: 2px solid #d4af37;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 20px;
            transition: transform 0.2s;
        }
        #music-control:hover {
            transform: scale(1.1);
        }

        /* Floating Hearts Animation */
        .heart {
            position: fixed;
            bottom: -10vh;
            font-size: 20px;
            color: #e74c3c;
            opacity: 0;
            z-index: 0;
            animation: floatUp 8s linear infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 0.8; }
            100% { transform: translateY(-110vh) scale(1.2); opacity: 0; }
        }

        /* Mobile Adjustments */
        @media (max-width: 750px) {
            .step div {
                width: 90%;
                margin: 0 auto;
            }
            #header h1 {
                font-size: 2.5em;
            }
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <div id="music-control" onclick="toggleMusic()">üéµ</div>
    <audio id="bg-music" loop>
        <source src="./assets/song.mp3" type="audio/mpeg">
    </audio>

    <div id="story">
        <div id="header">
            <h1>Our Journey</h1>
            <p>Scroll to explore our memories...</p>
        </div>
        <div id="features"></div>
    </div>

    <script src="./config.js"></script>

    <script>
        var layerTypes = {
            'fill': ['fill-opacity'],
            'line': ['line-opacity'],
            'circle': ['circle-opacity', 'circle-stroke-opacity'],
            'symbol': ['icon-opacity', 'text-opacity'],
            'raster': ['raster-opacity'],
            'fill-extrusion': ['fill-extrusion-opacity'],
            'heatmap': ['heatmap-opacity']
        }

        var alignments = {
            'left': 'lefty',
            'center': 'centered',
            'right': 'righty',
            'full': 'fully'
        }

        function getLayerPaintType(layer) {
            var layerType = map.getLayer(layer).type;
            return layerTypes[layerType];
        }

        function setLayerOpacity(layer) {
            var paintProps = getLayerPaintType(layer.layer);
            paintProps.forEach(function(prop) {
                var options = {};
                if (layer.duration) {
                    var transitionProp = prop + "-transition";
                    options = { "duration": layer.duration };
                    map.setPaintProperty(layer.layer, transitionProp, options);
                }
                map.setPaintProperty(layer.layer, prop, layer.opacity, options);
            });
        }

        var story = document.getElementById('story');
        var features = document.getElementById('features');
        var header = document.getElementById('header');

        // Check if config exists
        if (typeof config === 'undefined') {
            alert("Error: config.js not found. Make sure config.js is in the root folder.");
        }

        // Apply Config Info
        if (config.title) {
            document.title = config.title;
            header.querySelector('h1').innerText = config.title;
        }
        if (config.subtitle) {
            header.querySelector('p').innerText = config.subtitle;
        }

        // --- GENERATE CHAPTERS ---
        config.chapters.forEach((record, idx) => {
            var container = document.createElement('div');
            var chapter = document.createElement('div');

            if (record.title) {
                var title = document.createElement('h3');
                title.innerText = record.title;
                chapter.appendChild(title);
            }

            if (record.image) {
                var image = new Image();
                image.src = record.image;
                chapter.appendChild(image);
            }

            if (record.description) {
                var story = document.createElement('p');
                story.innerHTML = record.description;
                chapter.appendChild(story);
            }

            container.setAttribute('id', record.id);
            container.classList.add('step');
            if (idx === 0) {
                container.classList.add('active');
            }

            chapter.classList.add(alignments[record.alignment] || 'centered');
            container.appendChild(chapter);
            features.appendChild(container);
        });

        // --- MAPBOX SETUP ---
        mapboxgl.accessToken = config.accessToken;
        
        var map = new mapboxgl.Map({
            container: 'map',
            style: config.style,
            center: config.chapters[0].location.center,
            zoom: config.chapters[0].location.zoom,
            bearing: config.chapters[0].location.bearing,
            pitch: config.chapters[0].location.pitch,
            interactive: false
        });

        // --- SCROLLAMA SETUP ---
        var scroller = scrollama();

        map.on("load", function() {
            // Setup Scroller
            scroller
            .setup({
                step: '.step',
                offset: 0.5,
                progress: true
            })
            .onStepEnter(response => {
                var chapter = config.chapters.find(chap => chap.id === response.element.id);
                response.element.classList.add('active');
                
                // Move Map
                map.flyTo(chapter.location);

                // Handle Animations (CRASH FIX INCLUDED HERE)
                if (chapter.onChapterEnter && chapter.onChapterEnter.length > 0) {
                    chapter.onChapterEnter.forEach(setLayerOpacity);
                }
            })
            .onStepExit(response => {
                var chapter = config.chapters.find(chap => chap.id === response.element.id);
                response.element.classList.remove('active');
                
                // Handle Exits (CRASH FIX INCLUDED HERE)
                if (chapter.onChapterExit && chapter.onChapterExit.length > 0) {
                    chapter.onChapterExit.forEach(setLayerOpacity);
                }
            });
        });

        // --- FLOATING HEARTS SCRIPT ---
        function createHeart() {
            const heart = document.createElement("div");
            heart.classList.add("heart");
            heart.innerHTML = "‚ù§Ô∏è";
            heart.style.left = Math.random() * 100 + "vw";
            heart.style.animationDuration = Math.random() * 3 + 5 + "s";
            heart.style.fontSize = Math.random() * 20 + 10 + "px";
            document.body.appendChild(heart);
            setTimeout(() => { heart.remove(); }, 8000);
        }
        setInterval(createHeart, 800);

        // --- MUSIC TOGGLE SCRIPT ---
        function toggleMusic() {
            var audio = document.getElementById("bg-music");
            var btn = document.getElementById("music-control");
            if (audio.paused) {
                audio.play();
                btn.innerHTML = "‚è∏Ô∏è";
            } else {
                audio.pause();
                btn.innerHTML = "üéµ";
            }
        }
    </script>

</body>
</html>
